parameters:
  Nightly: false

steps:
  - pwsh: |
      if ("${{ parameters.Nightly }}" -eq "true") {
        pnpm install --no-frozen-lockfile
      } else {
        pnpm install
      }
      pnpm build
    displayName: Build Emitter Sources
    workingDirectory: $(TypeSpecRustPkgDir)

  - script: |
      pnpm eslint
    displayName: Run Lint
    workingDirectory: $(TypeSpecRustPkgDir)

  - script: |
      cspell -c .vscode/cspell.json .
    displayName: Run Spell Check
    workingDirectory: $(System.DefaultWorkingDirectory)

  - script: pnpm run test-ci
    displayName: Run TypeScript Tests
    workingDirectory: $(TypeSpecRustPkgDir)

  - task: PublishTestResults@2
    inputs:
      testRunner: JUnit
      testResultsFiles: $(TypeSpecRustPkgDir)/test-results.xml
      failTaskOnFailedTests: true

  - task: PublishCodeCoverageResults@2
    inputs:
      summaryFileLocation: $(TypeSpecRustPkgDir)/coverage/tmp/cobertura-coverage.xml
    displayName: Publish code coverage
    condition: ne('${{ parameters.Nightly }}', true)

  - pwsh: |
      pnpm run tspcompile --verbose
      pnpm -w modtidy $pwd
      if ("${{ parameters.Nightly }}" -eq "false") {
        git add -A .
        git diff --staged --exit-code
      }
    displayName: Regenerate Spector Tests
    workingDirectory: $(TypeSpecRustPkgDir)/test

  - pwsh: |
      cargo build
    displayName: Compile Tests
    workingDirectory: $(TypeSpecRustPkgDir)/test

  - pwsh: |
      cargo +stable clippy --workspace --all-features --all-targets --keep-going --no-deps
    displayName: Clippy
    workingDirectory: $(TypeSpecRustPkgDir)/test
    env:
      RUSTFLAGS: '-Dwarnings'

  - pwsh: |
      pnpm spector --start
      cargo test --no-fail-fast
      $code = $LASTEXITCODE
      pnpm spector --stop
      exit $code
    displayName: 'Run Spector Tests'
    timeoutInMinutes: 10
    workingDirectory: $(TypeSpecRustPkgDir)/test/spector
