steps:
  - script: |
      pnpm install
      pnpm build
    displayName: Build Emitter Sources
    workingDirectory: $(TypeSpecRustPkgDir)

  - script: |
      pnpm eslint
    displayName: Run Lint
    workingDirectory: $(TypeSpecRustPkgDir)

  - script: pnpm run test-ci
    displayName: Run TypeScript Tests
    workingDirectory: $(TypeSpecRustPkgDir)

  - task: PublishTestResults@2
    inputs:
      testRunner: JUnit
      testResultsFiles: $(TypeSpecRustPkgDir)/test-results.xml
      failTaskOnFailedTests: true

  - task: PublishCodeCoverageResults@2
    inputs:
      summaryFileLocation: $(TypeSpecRustPkgDir)/coverage/tmp/cobertura-coverage.xml
    displayName: Publish code coverage

  - script: |
      pnpm run tspcompile --verbose
      git add -A .
      git diff --staged 1>&2
    displayName: Regenerate Spector Tests
    workingDirectory: $(TypeSpecRustPkgDir)/test
    failOnStderr: true

  - pwsh: |
      cargo build
    displayName: Compile Tests
    workingDirectory: $(TypeSpecRustPkgDir)/test

  - pwsh: |
      cargo +stable clippy --workspace --all-features --all-targets --keep-going --no-deps
    displayName: Clippy
    workingDirectory: $(TypeSpecRustPkgDir)/test

  - pwsh: |
      pnpm spector --start
      cargo test --no-fail-fast
      $code = $LASTEXITCODE
      pnpm spector --stop
      exit $code
    displayName: "Run Spector Tests"
    timeoutInMinutes: 10
    workingDirectory: $(TypeSpecRustPkgDir)/test/spector
