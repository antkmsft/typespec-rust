parameters:
  nodeVersion: "20.x"
  rustVersion: "1.89"
  pnpmStorePath: $(Pipeline.Workspace)/.pnpm-store

steps:
  - task: NodeTool@0
    displayName: Install Node ${{ parameters.nodeVersion }}
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}

  - task: Cache@2
    inputs:
      key: 'pnpm | "$(Agent.OS)" | $(TypeSpecRustPkgDir)/pnpm-lock.yaml'
      path: ${{ parameters.pnpmStorePath }}
    displayName: Cache pnpm store

  - script:  npm install -g cspell
    displayName: Install cspell
  
  - script: |
      npm i -g corepack@latest
      corepack enable
      corepack prepare pnpm@latest-10 --activate
    displayName: Install pnpm

  - script: pnpm config set store-dir ${{ parameters.pnpmStorePath }}
    displayName: Setup pnpm cache dir

  - script: |
      echo "Node:"
      node -v
      echo "Pnpm:"
      pnpm -v
    displayName: Log tool versions used

  - script: |
      rustup install --no-self-update ${{ parameters.rustVersion }}
      rustup default ${{ parameters.rustVersion }}
      rustup show
    displayName: Install Rust
